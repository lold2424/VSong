# .github/workflows/deploy.yml

name: VSong Fullstack CI/CD

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. 코드 체크아웃
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. 백엔드 빌드 (경로 수정됨)
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew  # './backend/gradlew' -> './gradlew'
      - name: Build Backend with Gradle
        run: ./gradlew build     # './backend/gradlew' -> './gradlew'

      # 3. 프론트엔드 빌드 (경로 변경 없음)
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      - name: Install Frontend Dependencies
        run: npm install --prefix frontend
      - name: Build Frontend
        run: npm run build --prefix frontend
      
      # 4. 배포 전 서버 정리
      - name: Clear remote directories
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.OCI_SERVER_IP }}
          username: ${{ secrets.OCI_USERNAME }}
          key: ${{ secrets.OCI_SSH_PRIVATE_KEY }}
          script: |
            mkdir -p /home/opc/vsong
            sudo rm -rf /var/www/vsong-frontend/*

      # 5. 백엔드/프론트엔드 파일 전송 (SCP)
      - name: Copy Backend JAR to OCI
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.OCI_SERVER_IP }}
          username: ${{ secrets.OCI_USERNAME }}
          key: ${{ secrets.OCI_SSH_PRIVATE_KEY }}
          source: "build/libs/*.jar" # 'backend/build/libs/*.jar' -> 'build/libs/*.jar'
          target: "/home/opc/vsong/VSong.jar"

      - name: Copy Frontend files to OCI
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.OCI_SERVER_IP }}
          username: ${{ secrets.OCI_USERNAME }}
          key: ${{ secrets.OCI_SSH_PRIVATE_KEY }}
          source: "frontend/build/*"
          target: "/var/www/vsong-frontend"

      # 6. 서버에서 서비스 재시작
      - name: Restart services on OCI
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.OCI_SERVER_IP }}
          username: ${{ secrets.OCI_USERNAME }}
          key: ${{ secrets.OCI_SSH_PRIVATE_KEY }}
          script: |
            sudo systemctl restart vsong.service
            sudo systemctl restart nginx
            echo "Deployment Completed Successfully!"